---
description: Express.js API patterns and middleware conventions
globs:
  - "**/routes/**/*"
  - "**/middleware/**/*"
  - "**/controllers/**/*"
  - "**/api/**/*"
priority: 800
---

# Express.js Development Standards

## Project Structure

```
src/
├── app.ts              # Express app setup
├── server.ts           # Server entry point
├── routes/
│   ├── index.ts        # Route aggregator
│   ├── users.ts
│   └── posts.ts
├── controllers/
│   ├── userController.ts
│   └── postController.ts
├── middleware/
│   ├── auth.ts
│   ├── validate.ts
│   └── errorHandler.ts
├── services/
│   ├── userService.ts
│   └── postService.ts
├── models/
│   └── user.ts
└── utils/
    └── errors.ts
```

## Route Handlers

### Controller Pattern

```typescript
// controllers/userController.ts
import { Request, Response, NextFunction } from "express";
import { userService } from "../services/userService";

export const userController = {
  async getAll(req: Request, res: Response, next: NextFunction) {
    try {
      const users = await userService.findAll();
      res.json(users);
    } catch (error) {
      next(error);
    }
  },

  async getById(req: Request, res: Response, next: NextFunction) {
    try {
      const user = await userService.findById(req.params.id);
      if (!user) {
        return res.status(404).json({ error: "User not found" });
      }
      res.json(user);
    } catch (error) {
      next(error);
    }
  },

  async create(req: Request, res: Response, next: NextFunction) {
    try {
      const user = await userService.create(req.body);
      res.status(201).json(user);
    } catch (error) {
      next(error);
    }
  },
};
```

### Route Definition

```typescript
// routes/users.ts
import { Router } from "express";
import { userController } from "../controllers/userController";
import { authenticate } from "../middleware/auth";
import { validate } from "../middleware/validate";
import { createUserSchema } from "../schemas/user";

const router = Router();

router.get("/", userController.getAll);
router.get("/:id", userController.getById);
router.post("/", authenticate, validate(createUserSchema), userController.create);
router.put("/:id", authenticate, validate(updateUserSchema), userController.update);
router.delete("/:id", authenticate, userController.delete);

export default router;
```

## Middleware

### Authentication

```typescript
// middleware/auth.ts
import { Request, Response, NextFunction } from "express";

export interface AuthRequest extends Request {
  user?: { id: string; role: string };
}

export function authenticate(req: AuthRequest, res: Response, next: NextFunction) {
  const token = req.headers.authorization?.split(" ")[1];

  if (!token) {
    return res.status(401).json({ error: "Authentication required" });
  }

  try {
    const decoded = verifyToken(token);
    req.user = decoded;
    next();
  } catch {
    res.status(401).json({ error: "Invalid token" });
  }
}
```

### Validation

```typescript
// middleware/validate.ts
import { Request, Response, NextFunction } from "express";
import { ZodSchema } from "zod";

export function validate(schema: ZodSchema) {
  return (req: Request, res: Response, next: NextFunction) => {
    const result = schema.safeParse(req.body);

    if (!result.success) {
      return res.status(400).json({
        error: "Validation failed",
        details: result.error.issues,
      });
    }

    req.body = result.data;
    next();
  };
}
```

### Error Handling

```typescript
// middleware/errorHandler.ts
import { Request, Response, NextFunction } from "express";

export class AppError extends Error {
  constructor(
    public statusCode: number,
    message: string
  ) {
    super(message);
  }
}

export function errorHandler(
  err: Error,
  req: Request,
  res: Response,
  next: NextFunction
) {
  console.error(err.stack);

  if (err instanceof AppError) {
    return res.status(err.statusCode).json({ error: err.message });
  }

  res.status(500).json({ error: "Internal server error" });
}
```

## App Setup

```typescript
// app.ts
import express from "express";
import cors from "cors";
import helmet from "helmet";
import { errorHandler } from "./middleware/errorHandler";
import userRoutes from "./routes/users";

const app = express();

// Global middleware
app.use(helmet());
app.use(cors());
app.use(express.json());

// Routes
app.use("/api/users", userRoutes);

// Error handler (must be last)
app.use(errorHandler);

export default app;
```

## Best Practices

1. **Use async/await** - Wrap in try-catch or use express-async-handler
2. **Validate input** - Use Zod or Joi for request validation
3. **Centralize error handling** - Use error middleware
4. **Separate concerns** - Routes, controllers, services
5. **Use TypeScript** - Type your requests and responses
6. **Security middleware** - helmet, cors, rate limiting
