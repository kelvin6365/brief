---
description: Testing conventions and best practices
globs:
  - "**/*.test.*"
  - "**/*.spec.*"
  - "**/tests/**/*"
  - "**/__tests__/**/*"
priority: 700
---

# Testing Standards

## Test Structure

### File Organization

```
src/
├── components/
│   ├── Button.tsx
│   └── Button.test.tsx    # Colocated tests
└── utils/
    ├── format.ts
    └── format.test.ts
tests/                      # Integration/E2E tests
├── integration/
└── e2e/
```

### Test File Naming

- Unit tests: `*.test.ts` or `*.spec.ts`
- Integration tests: `*.integration.test.ts`
- E2E tests: `*.e2e.test.ts`

## Writing Tests

### AAA Pattern

```typescript
describe("UserService", () => {
  describe("createUser", () => {
    it("should create a user with valid data", async () => {
      // Arrange
      const userData = { name: "John", email: "john@example.com" };
      const mockDb = createMockDb();

      // Act
      const result = await createUser(userData, mockDb);

      // Assert
      expect(result.id).toBeDefined();
      expect(result.name).toBe("John");
      expect(mockDb.insert).toHaveBeenCalledWith("users", userData);
    });
  });
});
```

### Descriptive Test Names

```typescript
// Good - describes behavior
it("should throw ValidationError when email is invalid", () => {});
it("should return empty array when no users match filter", () => {});

// Avoid - vague or implementation-focused
it("works correctly", () => {});
it("calls the function", () => {});
```

## Test Types

### Unit Tests

```typescript
// Test pure functions
describe("calculateTotal", () => {
  it("should sum item prices", () => {
    const items = [{ price: 10 }, { price: 20 }];
    expect(calculateTotal(items)).toBe(30);
  });

  it("should return 0 for empty array", () => {
    expect(calculateTotal([])).toBe(0);
  });

  it("should apply discount when provided", () => {
    const items = [{ price: 100 }];
    expect(calculateTotal(items, 0.1)).toBe(90);
  });
});
```

### Integration Tests

```typescript
describe("User API", () => {
  beforeEach(async () => {
    await db.clear();
  });

  it("should create and retrieve a user", async () => {
    // Create
    const createRes = await api.post("/users", { name: "John" });
    expect(createRes.status).toBe(201);

    // Retrieve
    const getRes = await api.get(`/users/${createRes.body.id}`);
    expect(getRes.body.name).toBe("John");
  });
});
```

## Mocking

### Mock Functions

```typescript
// Create mock
const mockFetch = jest.fn();

// Setup return value
mockFetch.mockResolvedValue({ data: [] });

// Verify calls
expect(mockFetch).toHaveBeenCalledWith("/api/users");
expect(mockFetch).toHaveBeenCalledTimes(1);
```

### Mock Modules

```typescript
// Mock entire module
jest.mock("../api", () => ({
  fetchUsers: jest.fn().mockResolvedValue([]),
}));

// Mock specific export
jest.spyOn(api, "fetchUsers").mockResolvedValue([]);
```

## React Testing

```typescript
import { render, screen, fireEvent } from "@testing-library/react";

describe("Button", () => {
  it("should call onClick when clicked", () => {
    const handleClick = jest.fn();
    render(<Button onClick={handleClick}>Click me</Button>);

    fireEvent.click(screen.getByRole("button"));

    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  it("should be disabled when disabled prop is true", () => {
    render(<Button disabled>Click me</Button>);

    expect(screen.getByRole("button")).toBeDisabled();
  });
});
```

## Best Practices

1. **Test behavior, not implementation** - Focus on what the code does
2. **One assertion focus per test** - Test one thing at a time
3. **Keep tests independent** - No shared mutable state
4. **Use meaningful assertions** - Be specific about expectations
5. **Avoid testing internals** - Don't test private methods
6. **Maintain test data** - Use factories or fixtures
7. **Clean up after tests** - Reset state in afterEach

## Avoid These Patterns

- Testing implementation details
- Brittle selectors (prefer roles/labels)
- Excessive mocking (loses integration value)
- Testing third-party code
- Flaky tests (race conditions, timing)
